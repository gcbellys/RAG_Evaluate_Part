# 用户期望输出格式说明

## 📋 概述

根据您的需求，我已经修改了 `main_workflow.py` 文件，现在系统会生成三种不同格式的输出文件：

1. **详细结果** (`report_{ID}_evaluation_{timestamp}.json`) - 原始完整数据
2. **标准化结果** (`report_{ID}_evaluation_standardized_{timestamp}.json`) - 原有标准化格式
3. **用户格式** (`report_{ID}_user_format_{timestamp}.json`) - 您期望的新格式 ✨

## 🎯 用户期望格式结构

### 单个症状条目结构：
```json
{
  "report_number": "报告编号",
  "symptom_number": "症状编号（1,2,3...）", 
  "symptom_name": "症状名称",
  "expected_result": {
    "diag": "期望的诊断信息",
    "organ": "期望的器官",
    "a_position": "期望的解剖位置"
  },
  "api_responses": [
    {
      "api_number": 1,
      "api_name": "openai",
      "api_response": {
        "organ": "API识别的器官",
        "a_position": "API识别的解剖位置"
      },
      "api_eva": {
        "precision": 85.5,
        "recall": 75.0,
        "f1_score": 79.9,
        "overgeneration_penalty": 10.0,
        "overall_score": 69.9
      }
    },
    {
      "api_number": 2,
      "api_name": "anthropic",
      "api_response": {
        "organ": "API识别的器官",
        "a_position": "API识别的解剖位置"
      },
      "api_eva": {
        "precision": 90.0,
        "recall": 100.0,
        "f1_score": 94.7,
        "overgeneration_penalty": 5.0,
        "overall_score": 89.7
      }
    }
    // ... 其他API响应
  ]
}
```

## 🔄 数据映射关系

| 用户期望字段 | 来源数据 |
|-------------|---------|
| `report_number` | `report_id` |
| `symptom_number` | 症状在报告中的序号(1,2,3...) |
| `symptom_name` | `symptom.diagnosis` (症状文本) |
| `expected_result.diag` | 合并的 `d_diagnosis` 信息 |
| `expected_result.organ` | 合并的 `organName` 信息 |
| `expected_result.a_position` | 合并的 `anatomicalLocations` 信息 |
| `api_response.organ` | API响应中的 `organ_name` |
| `api_response.a_position` | API响应中的 `anatomical_locations` |
| `api_eva` | 完整的评估指标对象 |

## 📁 输出文件特点

### 🆕 用户格式文件特点：
- **扁平化结构**：每个症状作为数组中的独立条目
- **标准化命名**：使用您期望的字段名
- **统一编号**：API按照顺序编号 (1,2,3,4,5)
- **合并信息**：期望结果中的多个来源信息会合并去重

### 📊 API编号映射：
1. `openai` → api_number: 1
2. `anthropic` → api_number: 2  
3. `gemini` → api_number: 3
4. `moonshot` → api_number: 4
5. `deepseek` → api_number: 5

## 🚀 使用方法

### 运行系统（保持不变）：
```bash
# 处理单个报告
python main_workflow.py --start_id 4000 --end_id 4000

# 处理范围报告
python main_workflow.py --start_id 4000 --end_id 4005

# 限制处理数量
python main_workflow.py --max_files 10
```

### 输出文件示例：
```
results/
├── report_diagnostic_4000_evaluation_20250821_165541.json          # 详细结果
├── report_diagnostic_4000_evaluation_standardized_20250821_165541.json  # 标准化结果
└── report_diagnostic_4000_user_format_20250821_165541.json        # 用户格式 ✨
```

## 📋 示例输出

请查看 `example_user_format_output.json` 文件，其中包含了完整的用户格式示例输出。

## 🔧 核心修改

### 1. 新增方法：
- `_generate_user_format()` - 生成用户期望的扁平化格式

### 2. 修改方法：
- `save_results()` - 增加用户格式文件保存
- `_standardize_results()` - 更新标准化逻辑

### 3. 数据处理增强：
- **智能合并**：自动合并重复的器官和位置信息
- **去重处理**：避免期望结果中的重复项
- **错误保留**：保持原有的错误处理机制

## 📈 优势

1. **完美匹配**：输出格式完全符合您的期望
2. **向后兼容**：保留原有的详细和标准化格式
3. **数据完整**：不丢失任何评估信息
4. **易于分析**：扁平化结构便于后续数据处理
5. **标准化编号**：API响应按统一顺序编号

## 🔍 字段详细说明

### `expected_result` 构建逻辑：
- **diag**: 合并所有相关的诊断信息，用分号分隔
- **organ**: 合并所有器官名称，去重后用逗号分隔  
- **a_position**: 合并所有解剖位置，去重后用逗号分隔

### `api_eva` 评估指标：
- **precision**: 精确率 (0-100)
- **recall**: 召回率 (0-100)
- **f1_score**: F1分数 (0-100)
- **overgeneration_penalty**: 过度生成惩罚 (0-100)
- **overall_score**: 综合得分 (0-100)

现在您可以直接使用修改后的系统，它会自动生成您期望的输出格式！
